<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Hello World</title>
</head>
  <script src="pixi.min.js"></script>
<body>
  <script type="text/javascript">
    let type = "WebGL"
    if(!PIXI.utils.isWebGLSupported()){
      type = "canvas"
    }
	PIXI.utils.sayHello(type)
	//Create a Pixi Applicircleion
	let app = new PIXI.Application({
		width: 1000, 
		height: 1000,
        antialias: true,
        transparent: false,
        resolution: 1
		}
	);

	//Add the canvas that Pixi automatically created for you to the HTML document
	document.body.appendChild(app.view);
      
    var circle, state;
    var projectiles = [];
    var projectileSpeed = 5;
    
    
    
    app.stage.interactive = true;

    app.stage.on("mousedown", function(e){
        fireProjectile();
    })
    
    
   // if (app.renderer.plugins.interaction.mousedown){
    //     alert("hi");
    // }
    
	//load an image and run the `setup` function when it's done
   
	PIXI.loader
	  .add("images/placeholderCircle.png")
      .add("images/whiteball.png")
	  .load(setup);
      
    
	//This `setup` function will run when the image has loaded
	function setup() { 
       // projectile = new PIXI.Sprite(PIXI.loader.resources["images/whiteball.png"].texture);
       // app.stage.addChild(projectile)
      
        
        
		//Create the circle sprite
        circle = new PIXI.Sprite(PIXI.loader.resources["images/placeholderCircle.png"].texture);
		//Add the circle to the stage
        circle.y = 96;
        circle.vx = 0;
        circle.vy = 0;
        // set the point of rotation to be at the center of the sprite
        circle.anchor.set(0.5, 0.5);
		app.stage.addChild(circle);
		alert("CIRCLE ADDED!");
        
            //Capture the keyboard arrow keys
        let left = keyboard("a"),
            up = keyboard("w"),
            right = keyboard("d"),
            down = keyboard("s");

          //Left arrow key `press` method
          left.press = () => {
            //Change the circle's velocity when the key is pressed
            circle.vx = -5;
            //circle.vy = 0;
          };

          //Left arrow key `release` method
          left.release = () => {
            //If the left arrow has been released, and the right arrow isn't down,
            //and the circle isn't moving vertically:
            //Stop the circle
            if (!right.isDown) { // Had && circle.vy === 0
              circle.vx = 0;
            }
          };

          //Up
          up.press = () => {
            circle.vy = -5;
            //circle.vx = 0;
          };
          up.release = () => {
            if (!down.isDown) {
              circle.vy = 0;
            }
          };

          //Right
          right.press = () => {
            circle.vx = 5;
            //circle.vy = 0;
          };
          right.release = () => {
            if (!left.isDown) {
              circle.vx = 0;
            }
          };

          //Down
          down.press = () => {
            circle.vy = 5;
            //circle.vx = 0;
          };
          down.release = () => {
            if (!up.isDown) {
              circle.vy = 0;
            }
          };

      //Set the game state
      state = play;

      //Start the game loop 
      app.ticker.add(delta => gameLoop(delta));
      

    } // end setup
	
      function gameLoop(delta){
            state(delta);
	   }

	   function play(){
            move();
            rotate();
          if (projectiles.length != 0){
                for (var projectile = projectiles.length - 1; projectile >= 0; projectile--){
                projectiles[projectile].x += Math.cos(projectiles[projectile].rotation) * projectileSpeed;
                projectiles[projectile].y += Math.sin(projectiles[projectile].rotation) * projectileSpeed;
            }
           }
	   }
      
      // moves the circle depending on velocity and keyboard input
      function move(){
          circle.x += circle.vx;
          circle.y += circle.vy;
      }
      // rotates the circle where the mouse cursor is
        function rotate(){
            let mousePosition = findMousePosition();
            circle.rotation = Math.atan2(mousePosition.x - circle.x, -(mousePosition.y - circle.y));
        }
      
      function keyboard(value) {
          var key = {};
          key.value = value;
          key.isDown = false;
          key.isUp = true;
          key.press = undefined;
          key.release = undefined;
          //The `downHandler`
          key.downHandler = event => {
            if (event.key === key.value) {
              if (key.isUp && key.press) key.press();
              key.isDown = true;
              key.isUp = false;
              event.preventDefault();
            }
          };

          
          //The `upHandler`
          key.upHandler = event => {
            if (event.key === key.value) {
              if (key.isDown && key.release) key.release();
              key.isDown = false;
              key.isUp = true;
              event.preventDefault();
            }
          };

          //Attach event listeners
          const downListener = key.downHandler.bind(key);
          const upListener = key.upHandler.bind(key);

          window.addEventListener(
            "keydown", downListener, false
          );
          window.addEventListener(
            "keyup", upListener, false
          );

          // Detach event listeners
          key.unsubscribe = () => {
            window.removeEventListener("keydown", downListener);
            window.removeEventListener("keyup", upListener);
          };


        return key;
	}
      
    /*function createProjectile(){
       // projectile.visible = false;
        var projectile = new PIXI.Texture.fromImage('images/whiteball.png')
        projectile.x = circle.x;
        projectile.y = circle.y;
              
    }*/
      
    function fireProjectile()
    {
        //projectile.visible = true;
       // var projectile = new PIXI.Texture.fromImage('images/whiteball.png');
        var projectile = new PIXI.Sprite(PIXI.loader.resources["images/whiteball.png"].texture);
        projectile.x = circle.x;
        projectile.y = circle.y;
        let mousePosition = findMousePosition();
       // projectile.rotation = Math.atan2(mousePosition.x - projectile.x, -(mousePosition.y - projectile.y));
        projectile.rotation = circle.rotation - (Math.PI / 2);
        app.stage.addChild(projectile);
        projectiles.push(projectile);
        
        
    }

    function findMousePosition()
    {
        var mouseposition = app.renderer.plugins.interaction.mouse.global;
        return mouseposition;
        
    } 
      
    function hello(){
        alert("hello you left clicked");
    }
    
      
	


  </script>
</body>
</html>