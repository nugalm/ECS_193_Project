<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Hello World</title>

</head>
  <script src="pixi.min.js"></script>
     <script src="Character.js"></script>
    <script src="IceCharacter.js"></script>
    <script src="FireCharacter.js"></script>
    <script src="EarthCharacter.js"></script>
    <script src="WindCharacter.js"></script>
    <script src="CollisionDetector.js"></script>
    <script src="CollisionAction.js"></script>
    <script src="ContainCharacter.js"></script>
<body>
  <script type="text/javascript">
    let type = "WebGL"
    if(!PIXI.utils.isWebGLSupported()){
      type = "canvas"
    }
	PIXI.utils.sayHello(type)
	//Create a Pixi Applicircleion
	let app = new PIXI.Application({
		width: window.screen.width, 
		height: window.screen.height,
        antialias: true,
        transparent: false,
        resolution: 1
		}
	);

   app.stage.position.x = window.screen.width/2;
   app.stage.position.y = window.screen.height/2;
      //scale it
    app.stage.scale.x = 2.0;
   app.stage.scale.y = 2.0;

	//Add the canvas that Pixi automatically created for you to the HTML document
	document.body.appendChild(app.view);
      
    var circle, state, blueObject;
    var projectiles = [];
    var projectileSpeed = 15;
    var collision;
    
    // Whenever player left clicks on mouse, call fireProjectile()
   // document.body.addEventListener("click", function(e){
    window.addEventListener("click", function(e){
        
        fireProjectile();                        
    })

    // calling constructor with nulls because the respective elements' are initialized
    // by hardcoded values
    var ice = new IceCharacter();
    var fire = new FireCharacter(); 
    var earth = new EarthCharacter();
    var wind = new WindCharacter();
    
      
    //load an image and run the `setup` function when it's done
	PIXI.loader
	  .add("images/placeholderCircle.png")
      .add("images/whiteball.png")
      .add("images/blueObject.png")
	  .load(setup);   
    
	//This `setup` function will run when the image has loaded
	function setup() {     
        blueObject = new PIXI.Sprite(PIXI.loader.resources["images/blueObject.png"].texture);
        blueObject.y = 500;
        blueObject.x = 500;
        app.stage.addChild(blueObject);
        
		//Create the circle sprite
        circle = new PIXI.Sprite(PIXI.loader.resources["images/placeholderCircle.png"].texture);
		//Add the circle to the stage
        circle.y = 96;
        circle.vx = 0;
        circle.vy = 0;
        // set the point of rotation to be at the center of the sprite
        circle.anchor.set(0.5, 0.5);
		app.stage.addChild(circle);
        
            //Capture the keyboard arrow keys
        let left = keyboard("a"),
            up = keyboard("w"),
            right = keyboard("d"),
            down = keyboard("s");

          //Left arrow key `press` method
          left.press = () => {
            //Change the circle's velocity when the key is pressed
            circle.vx = -10;
            //circle.vy = 0;
          };

          //Left arrow key `release` method
          left.release = () => {
            //If the left arrow has been released, and the right arrow isn't down,
            //and the circle isn't moving vertically:
            //Stop the circle
            if (!right.isDown) { 
              circle.vx = 0;
            }
          };

          //Up
          up.press = () => {
            circle.vy = -10;
          };
          up.release = () => {
            if (!down.isDown) {
              circle.vy = 0;
            }
          };

          //Right
          right.press = () => {
            circle.vx = 10;
          };
          right.release = () => {
            if (!left.isDown) {
              circle.vx = 0;
            }
          };

          //Down
          down.press = () => {
            circle.vy = 10;
          };
          down.release = () => {
            if (!up.isDown) {
              circle.vy = 0;
            }
          };

      //Set the game state
      state = play;

      //Start the game loop 
      app.ticker.add(delta => gameLoop(delta));
      

    } // end setup
	
      function gameLoop(delta){
            state(delta);
	   }

	   function play(){
           let hitObject = false;
            move();
           rotate();
           containCharacter(circle, {x: 50, y:50, width:window.screen.width, height:window.screen.height});
           
           projectiles.forEach(function(projectile) {
                projectile.x += Math.cos(projectile.rotation) * projectileSpeed;
                projectile.y += Math.sin(projectile.rotation) * projectileSpeed;    
                
                if (collisionDetector(projectile, blueObject)){
                    hitObject = true;
                }
                                
            });
        
            // makes blueObject semi-transparent if hitObject is true
            collisionAction(hitObject, blueObject);
      
            
           
	   }
      
      // moves the circle depending on velocity and keyboard input
      function move(){
          circle.x += circle.vx;
          circle.y += circle.vy;
          app.stage.pivot.x = circle.x;
          app.stage.pivot.y = circle.y;
      }
      // rotates the circle where the mouse cursor is
        function rotate(){
            let mousePosition = findMousePosition();
            let tempX = circle.worldTransform.tx;
            let tempY = circle.worldTransform.ty;
            circle.rotation = Math.atan2(mousePosition.x - tempX, -(mousePosition.y - tempY));
        }
      
      function keyboard(value) {
          var key = {};
          key.value = value;
          key.isDown = false;
          key.isUp = true;
          key.press = undefined;
          key.release = undefined;
          //The `downHandler`
          key.downHandler = event => {
            if (event.key === key.value) {
              if (key.isUp && key.press) key.press();
              key.isDown = true;
              key.isUp = false;
              event.preventDefault();
            }
          };

          
          //The `upHandler`
          key.upHandler = event => {
            if (event.key === key.value) {
              if (key.isDown && key.release) key.release();
              key.isDown = false;
              key.isUp = true;
              event.preventDefault();
            }
          };

          //Attach event listeners
          const downListener = key.downHandler.bind(key);
          const upListener = key.upHandler.bind(key);

          window.addEventListener(
            "keydown", downListener, false
          );
          window.addEventListener(
            "keyup", upListener, false
          );

          // Detach event listeners
          key.unsubscribe = () => {
            window.removeEventListener("keydown", downListener);
            window.removeEventListener("keyup", upListener);
          };


        return key;
	}
            
    function fireProjectile()
    {
        let projectile = new PIXI.Sprite(PIXI.loader.resources["images/whiteball.png"].texture);
        projectile.x = circle.x;
        projectile.y = circle.y;
        let mousePosition = findMousePosition();
        projectile.rotation = circle.rotation - (Math.PI / 2);
        app.stage.addChild(projectile);
        projectiles.push(projectile);
       
               
    }

    function findMousePosition()
    {
        let mouseposition = app.renderer.plugins.interaction.mouse.global;
        return mouseposition;
        
    } 
        

  </script>
</body>
</html>